server:
  port: 8070
  shutdown: graceful # Enable graceful shutdown for zero-downtime deployments
  
spring:
  application:
    name: resilience4j-demo
    version: v2
  
  # Graceful Shutdown Configuration
  lifecycle:
    timeout-per-shutdown-phase: 30s

# Actuator Configuration - Enhanced for Kubernetes & Production
management:
  endpoints:
    web:
      base-path: /actuator
      exposure:
        include: "*" # Expose all endpoints for comprehensive monitoring
  
  endpoint:
    health:
      show-details: always
      probes:
        enabled: true # Enable Kubernetes liveness/readiness probes
      group:
        liveness:
          include: livenessState,ping
        readiness:
          include: readinessState,diskSpace
    metrics:
      enabled: true
    prometheus:
      enabled: true
  
  health:
    livenessState:
      enabled: true # K8s liveness probe
    readinessState:
      enabled: true # K8s readiness probe
    circuitbreakers:
      enabled: true
    ratelimiters:
      enabled: true
    diskspace:
      enabled: true
      threshold: 10MB
  
  # Metrics Configuration - Enhanced for monitoring
  metrics:
    tags:
      application: ${spring.application.name}
      version: v2
      environment: ${ENVIRONMENT:production}
      region: ${REGION:southeastasia}
    distribution:
      percentiles-histogram:
        http.server.requests: true # Enable histograms for better percentile calculation
    export:
      prometheus:
        enabled: true
        descriptions: true
        step: 1m
    enable:
      jvm: true
      process: true
      system: true
      tomcat: true
      logback: true
      http: true
  
  # Distributed tracing - Enhanced
  tracing:
    sampling:
      probability: 1.0 # 100% sampling for demo; use 0.1 (10%) in production
    baggage:
      enabled: true
      correlation:
        enabled: true

# Resilience4j Configuration - Production-Ready with Istio Integration
resilience4j:
  # Circuit Breaker Configuration
  circuitbreaker:
    instances:
      backendService:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 10s
        failureRateThreshold: 50
        eventConsumerBufferSize: 10
        recordExceptions:
          - org.springframework.web.client.HttpServerErrorException
          - java.io.IOException
          - java.util.concurrent.TimeoutException
      paymentService:
        registerHealthIndicator: true
        slidingWindowSize: 5
        minimumNumberOfCalls: 3
        permittedNumberOfCallsInHalfOpenState: 2
        waitDurationInOpenState: 5s
        failureRateThreshold: 60
        eventConsumerBufferSize: 10

  # Retry Configuration
  retry:
    instances:
      backendService:
        maxAttempts: 3
        waitDuration: 2s
        enableExponentialBackoff: true
        exponentialBackoffMultiplier: 2
        retryExceptions:
          - org.springframework.web.client.ResourceAccessException
          - java.io.IOException
        ignoreExceptions:
          - java.lang.IllegalArgumentException
      orderService:
        maxAttempts: 5
        waitDuration: 500ms
        enableExponentialBackoff: false
        retryExceptions:
          - java.io.IOException

  # Rate Limiter Configuration
  ratelimiter:
    instances:
      default:
        registerHealthIndicator: true
        limitForPeriod: 10
        limitRefreshPeriod: 1s
        timeoutDuration: 0s
        eventConsumerBufferSize: 100
      apiService:
        registerHealthIndicator: true
        limitForPeriod: 5
        limitRefreshPeriod: 1s
        timeoutDuration: 0s
      premiumService:
        registerHealthIndicator: true
        limitForPeriod: 100
        limitRefreshPeriod: 1s
        timeoutDuration: 0s

  # Bulkhead Configuration (Concurrency Control)
  bulkhead:
    instances:
      default:
        maxConcurrentCalls: 25
        maxWaitDuration: 0ms
      backendService:
        maxConcurrentCalls: 10
        maxWaitDuration: 100ms

  # TimeLimiter Configuration (Timeout Control)
  timelimiter:
    instances:
      default:
        timeoutDuration: 5s
        cancelRunningFuture: true
      backendService:
        timeoutDuration: 3s
        cancelRunningFuture: true

# Logging Configuration
logging:
  level:
    root: INFO
    io.github.resilience4j: DEBUG
    com.example.resilience: DEBUG
  pattern:
    console: "%clr(%d{yyyy-MM-dd HH:mm:ss.SSS}){faint} %clr([%mdc{traceId}/%mdc{spanId}]){yellow} %clr(%-5level){cyan} %clr(%logger{36}){blue} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%mdc{traceId}/%mdc{spanId}] [%thread] %-5level %logger{36} - %msg%n"

# Application Info for Actuator
info:
  app:
    name: ${spring.application.name}
    version: v2
    description: Resilience4j Demo V2 - Production Ready with Istio Integration
    features:
      - Graceful Shutdown
      - Health Probes (Liveness/Readiness)
      - Circuit Breaker
      - Retry Pattern
      - Rate Limiting
      - Bulkhead Pattern
      - Time Limiter
      - Prometheus Metrics
      - Distributed Tracing
