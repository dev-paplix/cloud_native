stages:
  - build
  - test
  - docker
  - deploy

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG

# Cache Maven dependencies
cache:
  paths:
    - .m2/repository/
    - target/

# Build Stage
build:
  stage: build
  image: maven:3.9.9-eclipse-temurin-23-alpine
  script:
    - cd resilience4j-demo
    - mvn clean compile -B
  artifacts:
    paths:
      - resilience4j-demo/target/
    expire_in: 1 hour

# Test Stage
test:
  stage: test
  image: maven:3.9.9-eclipse-temurin-23-alpine
  script:
    - cd resilience4j-demo
    - mvn test -B
  coverage: '/Total.*?([0-9]{1,3})%/'
  artifacts:
    when: always
    reports:
      junit:
        - resilience4j-demo/target/surefire-reports/TEST-*.xml

# Package Stage
package:
  stage: test
  image: maven:3.9.9-eclipse-temurin-23-alpine
  script:
    - cd resilience4j-demo
    - mvn package -DskipTests -B
  artifacts:
    paths:
      - resilience4j-demo/target/*.jar
    expire_in: 1 week

# Docker Build and Push
docker-build:
  stage: docker
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
  script:
    - cd resilience4j-demo
    - docker build -t $IMAGE_TAG .
    - docker tag $IMAGE_TAG $CI_REGISTRY_IMAGE:latest
    - docker push $IMAGE_TAG
    - docker push $CI_REGISTRY_IMAGE:latest
  only:
    - main
    - develop
    - tags

# Security Scan
security-scan:
  stage: docker
  image: aquasec/trivy:latest
  script:
    - trivy image --exit-code 0 --severity HIGH,CRITICAL $IMAGE_TAG
  allow_failure: true
  only:
    - main
    - develop

# Deploy to Development
deploy-dev:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - echo "Deploying to development environment"
    - kubectl config use-context dev-cluster
    - kubectl set image deployment/resilience4j-demo app=$IMAGE_TAG -n development
    - kubectl rollout status deployment/resilience4j-demo -n development
  environment:
    name: development
    url: https://dev.example.com
  only:
    - develop
  when: manual

# Deploy to Production
deploy-prod:
  stage: deploy
  image: bitnami/kubectl:latest
  script:
    - echo "Deploying to production environment"
    - kubectl config use-context prod-cluster
    - kubectl set image deployment/resilience4j-demo app=$IMAGE_TAG -n production
    - kubectl rollout status deployment/resilience4j-demo -n production
  environment:
    name: production
    url: https://prod.example.com
  only:
    - tags
  when: manual
