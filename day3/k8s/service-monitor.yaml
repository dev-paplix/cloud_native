# Prometheus ServiceMonitor for metrics scraping
# Requires Prometheus Operator to be installed
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: resilience4j-demo
  namespace: observability-demo
  labels:
    app: resilience4j-demo
    prometheus: kube-prometheus
spec:
  selector:
    matchLabels:
      app: resilience4j-demo
  endpoints:
  - port: http
    path: /actuator/prometheus
    interval: 30s
    scrapeTimeout: 10s
    scheme: http
    relabelings:
    - sourceLabels: [__meta_kubernetes_pod_name]
      targetLabel: pod
    - sourceLabels: [__meta_kubernetes_namespace]
      targetLabel: namespace
    - sourceLabels: [__meta_kubernetes_pod_node_name]
      targetLabel: node
---
# PrometheusRule for alerting
# Defines Prometheus alert rules
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: resilience4j-demo-alerts
  namespace: observability-demo
  labels:
    app: resilience4j-demo
    prometheus: kube-prometheus
spec:
  groups:
  - name: resilience4j-demo.rules
    interval: 30s
    rules:
    # High Error Rate Alert
    - alert: HighErrorRate
      expr: |
        (
          sum(rate(http_server_requests_seconds_count{status=~"5..",namespace="observability-demo"}[5m]))
          /
          sum(rate(http_server_requests_seconds_count{namespace="observability-demo"}[5m]))
        ) > 0.01
      for: 5m
      labels:
        severity: critical
        component: application
      annotations:
        summary: "High error rate detected"
        description: "Error rate is {{ $value | humanizePercentage }} (threshold: 1%)"
    
    # High P95 Latency Alert
    - alert: HighP95Latency
      expr: |
        histogram_quantile(0.95,
          sum(rate(http_server_requests_seconds_bucket{namespace="observability-demo"}[5m])) by (le)
        ) > 0.5
      for: 10m
      labels:
        severity: warning
        component: application
      annotations:
        summary: "High P95 latency detected"
        description: "P95 latency is {{ $value }}s (threshold: 0.5s)"
    
    # Pod Not Ready
    - alert: PodNotReady
      expr: |
        kube_pod_status_ready{condition="true",namespace="observability-demo",pod=~"resilience4j-demo.*"} == 0
      for: 5m
      labels:
        severity: warning
        component: infrastructure
      annotations:
        summary: "Pod not ready"
        description: "Pod {{ $labels.pod }} has been not ready for 5 minutes"
    
    # High CPU Usage
    - alert: HighCPUUsage
      expr: |
        sum(rate(container_cpu_usage_seconds_total{namespace="observability-demo",pod=~"resilience4j-demo.*"}[5m])) by (pod)
        /
        sum(kube_pod_container_resource_limits{namespace="observability-demo",pod=~"resilience4j-demo.*",resource="cpu"}) by (pod)
        > 0.8
      for: 10m
      labels:
        severity: warning
        component: infrastructure
      annotations:
        summary: "High CPU usage"
        description: "Pod {{ $labels.pod }} CPU usage is {{ $value | humanizePercentage }}"
    
    # High Memory Usage
    - alert: HighMemoryUsage
      expr: |
        sum(container_memory_working_set_bytes{namespace="observability-demo",pod=~"resilience4j-demo.*"}) by (pod)
        /
        sum(kube_pod_container_resource_limits{namespace="observability-demo",pod=~"resilience4j-demo.*",resource="memory"}) by (pod)
        > 0.9
      for: 5m
      labels:
        severity: critical
        component: infrastructure
      annotations:
        summary: "High memory usage"
        description: "Pod {{ $labels.pod }} memory usage is {{ $value | humanizePercentage }}"
    
    # Circuit Breaker Open
    - alert: CircuitBreakerOpen
      expr: |
        resilience4j_circuitbreaker_state{namespace="observability-demo",state="open"} > 0
      for: 2m
      labels:
        severity: warning
        component: application
      annotations:
        summary: "Circuit breaker is open"
        description: "Circuit breaker {{ $labels.name }} is open"
    
    # Request Rate Drop
    - alert: RequestRateDrop
      expr: |
        (
          sum(rate(http_server_requests_seconds_count{namespace="observability-demo"}[5m]))
          <
          sum(rate(http_server_requests_seconds_count{namespace="observability-demo"}[1h] offset 1h)) * 0.5
        )
      for: 10m
      labels:
        severity: warning
        component: application
      annotations:
        summary: "Request rate dropped significantly"
        description: "Current rate is 50% lower than 1 hour ago"
